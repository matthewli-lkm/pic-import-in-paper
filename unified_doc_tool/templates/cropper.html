{% extends 'base.html' %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<style>
    /* Clean "Print Preview" Style */
    #image { display: block; max-width: 100%; max-height: 60vh; margin: 0 auto; }
    #crop-container { 
        max-width: 100%; 
        max-height: 60vh; 
        overflow: hidden; 
        background-color: #333; /* Darker background like print preview */
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Remove the default heavy grid from Cropper */
    .cropper-view-box {
        outline: 1px solid #fff;
        outline-color: rgba(255, 255, 255, 0.75);
    }
    .cropper-line, .cropper-point {
        background-color: #fff;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0 fs-5">Image Cropper</h3>
            </div>
            <div class="card-body">
                <form id="upload-form" method="POST" enctype="multipart/form-data">
                    <div class="input-group mb-3">
                        <input type="file" class="form-control" name="file" id="file-input" accept=".pdf,image/*" required>
                        <button class="btn btn-outline-secondary" type="submit">Upload & Start</button>
                    </div>
                </form>

                <div id="crop-area" style="display:none;">
                    <!-- Page Navigation for PDFs -->
                    <div id="pdf-controls" class="mb-3 p-2 bg-light rounded d-flex justify-content-between align-items-center" style="display:none !important;">
                        <div>
                             <span class="fw-bold">PDF Page:</span> 
                             <span id="current-page">1</span> / <span id="total-pages">?</span>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="prev-page" disabled>Previous</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="next-page">Next</button>
                        </div>
                    </div>

                    <div id="crop-container" class="mb-3">
                        <img id="image" src="" alt="To crop"/>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                             <button class="btn btn-success" id="download-btn">Crop & Download</button>
                             <button class="btn btn-info text-white" id="save-btn">Save to Assets</button>
                        </div>
                        <button class="btn btn-secondary" onclick="location.reload()">Reset</button>
                    </div>
                </div>
                
                <div id="result-message" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    let cropper;
    let currentPdfFilename = null;
    let currentPdfPage = 1;
    let totalPdfPages = 0;
    
    document.getElementById('upload-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        document.querySelector('button[type="submit"]').textContent = 'Uploading...';
        
        try {
            const res = await fetch("{{ url_for('cropper.upload') }}", { method: 'POST', body: formData });
            
            if(!res.ok) throw new Error("Upload failed");
            
            const data = await res.json();
            if (data.image_url) {
                // PDF Handling
                if (data.is_pdf) {
                    currentPdfFilename = data.pdf_filename;
                    totalPdfPages = data.num_pages;
                    currentPdfPage = 1;
                    
                    document.getElementById('pdf-controls').style.setProperty('display', 'flex', 'important');
                    document.getElementById('total-pages').textContent = totalPdfPages;
                    updatePageButtons();
                } else {
                     document.getElementById('pdf-controls').style.setProperty('display', 'none', 'important');
                }

                initCropper(data.image_url);
                document.getElementById('crop-area').style.display = 'block';
                document.getElementById('upload-form').style.display = 'none';
            }
        } catch (err) {
            alert('Error uploading file');
            console.error(err);
        } finally {
            document.querySelector('button[type="submit"]').textContent = 'Upload & Start';
        }
    };

    function initCropper(imageUrl) {
        const image = document.getElementById('image');
        image.src = imageUrl + '?t=' + Date.now();
        
        if (cropper) cropper.destroy();
        
        cropper = new Cropper(image, { 
            viewMode: 1, 
            modal: true,
            guides: false,       // Hide dashed grid
            center: false,       // Hide center indicator
            highlight: false,    // Hide white overlay on selection (optional, keeping selection clear)
            background: false,   // Hide checkerboard
            autoCropArea: 0.8,
            movable: false,
            zoomable: false,
            rotatable: true,
            scalable: false
        });
    }

    async function changePage(offset) {
        if (!currentPdfFilename) return;
        
        const newPage = currentPdfPage + offset;
        if (newPage < 1 || newPage > totalPdfPages) return;
        
        // Show loading state?
        if(cropper) cropper.disable();
        
        try {
            const res = await fetch("{{ url_for('cropper.get_page') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: currentPdfFilename, page: newPage })
            });
            const data = await res.json();
            
            if (data.image_url) {
                currentPdfPage = newPage;
                ['current-page'].forEach(id => document.getElementById(id).textContent = currentPdfPage);
                initCropper(data.image_url);
                updatePageButtons();
            }
        } catch(e) {
            console.error(e);
            alert("Error changing page");
        }
    }

    function updatePageButtons() {
        document.getElementById('prev-page').disabled = (currentPdfPage <= 1);
        document.getElementById('next-page').disabled = (currentPdfPage >= totalPdfPages);
    }

    document.getElementById('prev-page').onclick = () => changePage(-1);
    document.getElementById('next-page').onclick = () => changePage(1);

    async function processCrop(action) {
        if (!cropper) return;
        
        cropper.getCroppedCanvas().toBlob(async function(blob) {
            const formData = new FormData();
            formData.append('cropped_image', blob, 'crop.png');
            formData.append('action', action);
            
            const btn = action === 'download' ? document.getElementById('download-btn') : document.getElementById('save-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;

            try {
                const res = await fetch("{{ url_for('cropper.process') }}", { method: 'POST', body: formData });
                
                if (action === 'download') {
                     if (res.ok) {
                        const url = window.URL.createObjectURL(await res.blob());
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'cropped_transparent.png';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.getElementById('result-message').innerHTML = '<div class="alert alert-success">Download started!</div>';
                     }
                } else {
                    const data = await res.json();
                    if(data.status === 'success') {
                         document.getElementById('result-message').innerHTML = '<div class="alert alert-success">Saved to Asset Library! You can now use this in the Watermarker tool.</div>';
                    }
                }
            } catch (error) {
                console.error(error);
                alert('Processing failed');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }, 'image/png');
    }

    document.getElementById('download-btn').onclick = () => processCrop('download');
    document.getElementById('save-btn').onclick = () => processCrop('save');
</script>
{% endblock %}
